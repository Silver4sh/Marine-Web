{% extends 'dashboard/base.html' %}

{% block title %}Survey - MarineOS{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h1 class="text-gradient">Laporan Survei</h1>
        <p>Manajemen laporan survei lapangan dan inspeksi kapal.</p>
    </div>
    <button class="btn-primary" onclick="openModal()">
        <i class="ph-bold ph-plus"></i> Buat Laporan
    </button>
</div>

<!-- Survey List -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3><i class="ph ph-clipboard-text"></i> Daftar Survei</h3>
        <input type="text" id="searchInput" placeholder="Cari laporan..." class="form-input" style="width: 250px;"
            onkeyup="searchTable()">
    </div>

    <div style="overflow-x: auto;">
        <table class="table" id="surveyTable">
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>Kode</th>
                    <th>Proyek</th>
                    <th>Site</th>
                    <th>Kapal</th>
                    <th>Surveyor</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for survey in surveys %}
                <tr>
                    <td>{{ survey.date_survey|date:"d M Y" }}</td>
                    <td><span class="status-badge"
                            style="background: rgba(56, 189, 248, 0.1); color: #38bdf8; border: 1px solid rgba(56, 189, 248, 0.2);">{{
                            survey.code_report }}</span></td>
                    <td>{{ survey.project_name }}</td>
                    <td>{{ survey.site_name|default:"-" }}</td>
                    <td>{{ survey.vessel_name|default:"-" }}</td>
                    <td>{{ survey.surveyor_name|default:"-" }}</td>
                    <td>
                        <button class="btn-icon" title="Lihat Detail"><i class="ph ph-eye"></i></button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 2rem;">Belum ada
                        laporan survei.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create Modal -->
<div id="createModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
    <div class="modal-content text-glow"
        style="background: #0f172a; width: 90%; max-width: 600px; padding: 2rem; border-radius: 16px; border: 1px solid var(--primary); position: relative;">
        <button onclick="closeModal()"
            style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>

        <h2 style="margin-bottom: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0.5rem;">Buat
            Laporan Baru</h2>

        <form method="POST" action="{% url 'create_survey' %}">
            {% csrf_token %}
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label class="form-label">Nama Proyek</label>
                    <input type="text" name="project_name" class="form-input" required>
                </div>
                <div>
                    <label class="form-label">Kode Laporan</label>
                    <input type="text" name="code_report" class="form-input" placeholder="SRV-YYYY-XXX" required>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label class="form-label">Site</label>
                    <select name="id_site" class="form-select">
                        <option value="">Pilih Site</option>
                        {% for site in sites %}
                        <option value="{{ site.code_site }}">{{ site.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="form-label">Kapal</label>
                    <select name="id_vessel" class="form-select">
                        <option value="">Pilih Kapal</option>
                        {% for vessel in vessels %}
                        <option value="{{ vessel.code_vessel }}">{{ vessel.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <label class="form-label">Tanggal Survei</label>
                <input type="date" name="date_survey" class="form-input" required value="{% now 'Y-m-d' %}">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label class="form-label">Komentar / Catatan</label>
                <textarea name="comment" class="form-input" rows="3"></textarea>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" class="btn-secondary" onclick="closeModal()">Batal</button>
                <button type="submit" class="btn-primary">Simpan Laporan</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openModal() {
        document.getElementById('createModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('createModal').style.display = 'none';
    }

    function searchTable() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("searchInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("surveyTable");
        tr = table.getElementsByTagName("tr");
        for (i = 0; i < tr.length; i++) {
            td = tr[i].getElementsByTagName("td");
            if (td.length > 0) {
                var found = false;
                for (var j = 0; j < td.length; j++) {
                    if (td[j]) {
                        txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }
                if (found) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>
{% endblock %}