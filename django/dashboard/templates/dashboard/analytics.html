{% extends 'dashboard/base.html' %}

{% block title %}Analytics - MarineOS{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h1 class="text-gradient">Pusat Analitik</h1>
        <p>Analisis tren, prediksi, dan wawasan AI.</p>
    </div>
</div>

<!-- AI Insight Header -->
{% if ai_insights %}
<div style="background: linear-gradient(90deg, rgba(14, 165, 233, 0.1) 0%, rgba(15, 23, 42, 0) 100%); 
            border: 1px solid rgba(56, 189, 248, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
    <div style="display: flex; gap: 12px; align-items: start;">
        <div style="font-size: 1.5rem;">ðŸ¤–</div>
        <div>
            <div style="font-weight: 600; color: #e0f2fe; margin-bottom: 4px;">{{ ai_insights.0.title }}</div>
            <div style="color: #94a3b8; font-size: 0.95rem; line-height: 1.5;">{{ ai_insights.0.desc }}</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Overview Strip -->
<div class="metric-grid">
    <div class="metric-card">
        <div class="metric-label">Total Pendapatan (Gross)</div>
        <div class="metric-value">Rp {{ fin.total_revenue|floatformat:0 }}</div>
        <div style="color: var(--success); font-size: 0.9rem;">+{{ fin.delta_revenue }}% vs last month</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Pesanan Selesai</div>
        <div class="metric-value">{{ fin.completed_orders }}</div>
        <div style="color: var(--primary); font-size: 0.9rem;">Total {{ orders.total_orders }} orders</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Klien Aktif</div>
        <div class="metric-value">{{ clients.total_clients }}</div>
        <div>
            <h5>ðŸ¤– Analisis Kausalitas</h5>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                {% for insight in corr_insights %}
                <div
                    style="border-left: 3px solid {% if insight.type == 'critical' %}#ef4444{% else %}#10b981{% endif %}; 
                                   padding-left: 12px; padding: 10px; background: rgba(255,255,255,0.02); border-radius: 0 8px 8px 0;">
                    <div style="font-weight: 600; font-size: 0.85rem; color: #f1f5f9;">{{ insight.title }}</div>
                    <div style="font-size: 0.8rem; color: #94a3b8;">{{ insight.desc }}</div>
                </div>
                {% empty %}
                <div style="color: var(--text-secondary);">Data belum cukup untuk korelasi.</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
</div>

<!-- Side Column -->
<div style="display: flex; flex-direction: column; gap: 1.5rem;">
    <div class="card">
        <h3><i class="ph ph-chart-bar"></i> Kinerja Logistik</h3>
        <p style="color: var(--text-secondary); font-size: 0.9rem;">Coming Soon.</p>
    </div>
</div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- FORECAST CHART ---
        const forecastDataRaw = {{ forecast_data| safe
    }};
    if (forecastDataRaw.length > 0) {
        const actual = forecastDataRaw.filter(d => d.type === 'Aktual');
        const forecast = forecastDataRaw.filter(d => d.type === 'Prakiraan');

        // Confidence Interval
        const xConf = forecast.map(d => d.month_str).concat(forecast.map(d => d.month_str).reverse());
        const yConf = forecast.map(d => d.upper_bound).concat(forecast.map(d => d.lower_bound).reverse());

        const traces = [
            {
                x: xConf, y: yConf,
                fill: 'toself',
                fillcolor: 'rgba(56, 189, 248, 0.1)',
                line: { color: 'rgba(255,255,255,0)' },
                name: 'Interval Keyakinan 95%',
                hoverinfo: 'skip',
                showlegend: false
            },
            {
                x: actual.map(d => d.month_str),
                y: actual.map(d => d.revenue),
                mode: 'lines+markers',
                name: 'Data Aktual',
                line: { color: '#34d399', width: 3 },
                marker: { size: 6, color: '#0f172a', line: { width: 2, color: '#34d399' } }
            },
            {
                x: forecast.map(d => d.month_str),
                y: forecast.map(d => d.revenue),
                mode: 'lines+markers',
                name: 'Proyeksi AI',
                line: { color: '#38bdf8', width: 3, dash: 'dash' },
                marker: { size: 6, symbol: 'diamond-open', color: '#38bdf8' }
            }
        ];

        const layout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#94a3b8', family: "'Plus Jakarta Sans', sans-serif" },
            xaxis: { showgrid: false, zeroline: false },
            yaxis: { showgrid: true, gridcolor: 'rgba(255,255,255,0.05)', tickformat: 's', zeroline: false },
            margin: { l: 40, r: 20, t: 30, b: 40 },
            legend: { orientation: 'h', y: -0.2 }
        };

        Plotly.newPlot('forecast-chart', traces, layout, { responsive: true, displayModeBar: false });
    } else {
        document.getElementById('forecast-chart').innerHTML = "<div style='display:flex;align-items:center;justify-content:center;height:100%;color:#64748b;'>Data tidak mencukupi untuk prediksi.</div>";
    }

    // --- UTILIZATION CHART ---
    const utilDataRaw = JSON.parse('{{ utilization_data|escapejs }}');
    if (utilDataRaw.length > 0) {
        const utilData = [{
            x: utilDataRaw.map(d => d.vessel_name),
            y: utilDataRaw.map(d => d.utilization_rate),
            type: 'bar',
            marker: {
                color: utilDataRaw.map(d => d.utilization_rate > 80 ? '#22c55e' : (d.utilization_rate < 50 ? '#f43f5e' : '#eab308'))
            },
            name: 'Utilisasi (%)'
        }];

        const utilLayout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#94a3b8' },
            margin: { t: 0, b: 40, l: 40, r: 0 },
            xaxis: { title: 'Kapal' },
            yaxis: { title: 'Rate (%)', range: [0, 100] }
        };
        Plotly.newPlot('utilization-chart', utilData, utilLayout);
    } else {
        document.getElementById('utilization-chart').innerHTML = "<div class='text-center p-4'>Data tidak tersedia.</div>";
    }

    // --- CORRELATION CHART ---
    const corrDataRaw = {{ corr_matrix_json| safe }};
    if (corrDataRaw && corrDataRaw.data) {
        const data = [{
            z: corrDataRaw.data,
            x: corrDataRaw.columns,
            y: corrDataRaw.index,
            type: 'heatmap',
            colorscale: 'RdBu',
            reversescale: true,
            zmin: -1, zmax: 1
        }];

        const layout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#94a3b8', family: "'Plus Jakarta Sans', sans-serif" },
            margin: { l: 50, r: 0, t: 0, b: 50 },
            xaxis: { side: 'bottom' },
            yaxis: { autorange: 'reversed' }
        };

        Plotly.newPlot('corr-chart', data, layout, { responsive: true, displayModeBar: false });
    } else {
        document.getElementById('corr-chart').innerHTML = "<div style='display:flex;align-items:center;justify-content:center;height:100%;color:#64748b;'>Data variansi 0 atau kosong.</div>";
    }
    });
</script>
{% endblock %}